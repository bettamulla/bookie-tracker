<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matched Betting Tracker</title>
<meta name="description" content="Dark, minimal matched betting tracker with calculator, charts, and offline PWA install.">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="icons/favicon.png">
<meta name="theme-color" content="#0d1117">
<meta property="og:title" content="Matched Betting Tracker">
<meta property="og:description" content="Track bets, calculate lays, export data. Offline PWA.">
<meta property="og:image" content="icons/og-image.png">
<meta property="og:type" content="website">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{--bg:#0d1117;--surface:#161b22;--card:#1c2128;--ink:#e6edf3;--muted:#8b949e;--line:#30363d;--acc:#2ea043;--acc2:#1e9b73;--danger:#f85149}
*{box-sizing:border-box} html,body{margin:0;height:100%} body{background:var(--bg);color:var(--ink);font:14px/1.5 'Inter',system-ui}
.wrap{max-width:1200px;margin:auto;padding:16px 16px 64px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px} h1{margin:0;font-size:18px}
.top-tabs{display:none;gap:8px;margin:12px 0;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#0f1623;color:var(--ink);cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--acc),var(--acc2));border:none;color:#fff;font-weight:700}
.panel{display:none}.panel.active{display:block;animation:fade .25s ease}
@keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
input,select,button,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1623;color:var(--ink)}
input[type=checkbox]{width:auto}
.btn{background:linear-gradient(90deg,var(--acc),var(--acc2));border:none;color:#fff;font-weight:700;cursor:pointer}
.btn.sec{background:transparent;border:1px solid var(--line);color:var(--ink);font-weight:600}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}.kpi .box{background:var(--surface);border:1px solid var(--line);border-radius:10px;padding:10px;text-align:center}.kpi .val{font-weight:800}
.tableWrap{overflow:auto;max-height:480px;border:1px solid var(--line);border-radius:10px;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:13px}th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}th{color:var(--muted);position:sticky;top:0;background:#111827}.right{text-align:right}
.status-badge{padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}.status-pending{background:#d29922}.status-back{background:#2ea043}.status-lay{background:#f85149}.status-void{background:#6b7280}.status-cancelled{background:#9ca3af}
details.rowx{background:#0f1623;border:1px dashed var(--line);border-radius:10px;padding:10px;margin-top:8px}.muted{color:var(--muted);font-size:12px}
.charts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#0f1623;border-top:1px solid var(--line);display:flex;justify-content:space-around;padding:8px 6px;z-index:999}
.navbtn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 10px;border-radius:10px;border:1px solid transparent;color:#e6edf3;background:transparent}
.navbtn.active{border-color:var(--acc);background:rgba(46,160,67,.08)}
.navbtn i{font-size:16px}
.footer{text-align:center;color:var(--muted);font-size:12px;margin-top:12px}
#splash{position:fixed;inset:0;background:#0d1117;display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .3s ease;opacity:1}
.loader{width:36px;height:36px;border:3px solid #30363d;border-top-color:#2ea043;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(min-width:900px){.top-tabs{display:flex}.bottom-nav{display:none}.wrap{padding-bottom:16px}}
@media(max-width:820px){.row{grid-template-columns:1fr}.kpi{grid-template-columns:1fr}.charts{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="splash"><div class="loader" aria-label="Loading"></div></div>

<div class="wrap">
  <header><h1>Matched Betting Tracker</h1></header>

  <nav class="top-tabs">
    <button class="tab active" data-tab="calc">Calculator</button>
    <button class="tab" data-tab="tracker">Tracker</button>
    <button class="tab" data-tab="reports">Reports</button>
    <button class="tab" data-tab="guide">Guide</button>
    <button class="tab" data-tab="bin">Recycle Bin</button>
  </nav>

  <section id="calc" class="panel active">
    <div class="card">
      <div class="row">
        <div><label>Bet type <span title="QB = Qualifying Bet. SNR = Free Bet where stake is not returned.">?</span></label>
          <select id="betType"><option value="QB">Qualifying Bet</option><option value="SNR">Free Bet (SNR)</option></select></div>
        <div><label>Odds format <span title="Decimal e.g. 3.2, Fractional 11/5, American +220/-150">?</span></label>
          <select id="oddsFormat"><option value="dec">Decimal</option><option value="frac">Fractional</option><option value="amer">American</option></select></div>
      </div>
      <div class="row"><div><label>Back stake (£)</label><input id="backStake" type="number" value="10" step="0.01"></div><div><label>Commission %</label><input id="comm" type="number" value="2" step="0.01"></div></div>
      <div class="row"><div><label>Back odds</label><input id="backOdds" type="text" value="3.2"></div><div><label>Lay odds</label><input id="layOdds" type="text" value="3.35"></div></div>
      <div class="row"><div><label>Bookmaker</label><input id="bookie" placeholder="SkyBet"></div><div><label>Event</label><input id="event" placeholder="Arsenal v Spurs — Draw"></div></div>
      <div><label>Notes</label><input id="notes" placeholder="2UP, price boost"></div>
      <div class="row" style="margin-top:8px"><button id="calcBtn" class="btn sec">Calculate</button><button id="logBtn" class="btn">Add to Tracker</button></div>
      <div class="kpi" style="margin-top:8px">
        <div class="box"><div>Lay stake</div><div id="kLayStake" class="val">£0.00</div></div>
        <div class="box"><div>Liability</div><div id="kLiability" class="val">£0.00</div></div>
        <div class="box"><div>Expected profit</div><div id="kProfit" class="val">£0.00</div></div>
      </div>
      <div style="margin-top:6px"><div>If Back wins: <span id="outBack">–</span></div><div>If Lay wins: <span id="outLay">–</span></div></div>
      <div id="exposureWarn" style="display:none;color:#f85149;font-weight:700;margin-top:6px">Warning: liability exceeds exposure cap</div>
    </div>
  </section>

  <section id="tracker" class="panel">
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <input id="search" placeholder="Search bookmaker, event, notes" style="flex:1;min-width:180px">
        <select id="statusFilter"><option value="">All statuses</option><option>Pending</option><option>Back Won</option><option>Lay Won</option><option>Void</option><option>Cancelled</option></select>
        <select id="bookFilter"><option value="">All bookmakers</option></select>
        <select id="typeFilter"><option value="">All bet types</option><option value="QB">Qualifying Bet</option><option value="SNR">Free Bet (SNR)</option></select>
        <button id="clearFilters" class="btn sec">Clear</button>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="exportCsv" class="btn sec"><i class="fa-solid fa-file-arrow-down"></i> CSV</button>
          <button id="exportXlsx" class="btn sec"><i class="fa-solid fa-file-excel"></i> Excel</button>
          <input id="csvInput" type="file" accept=".csv" style="display:none">
          <button id="importCsv" class="btn sec"><i class="fa-solid fa-file-arrow-up"></i> Import</button>
          <button id="clearAll" class="btn" style="background:#f85149">Clear All</button>
        </div>
      </div>
      <div class="kpi">
        <div class="box"><div>P&L</div><div id="pnlNow" class="val">£0.00</div></div>
        <div class="box"><div>ROI</div><div id="roiNow" class="val">0%</div></div>
        <div class="box"><div>Pending</div><div id="pendingNow" class="val">0</div></div>
      </div>
      <div class="tableWrap" style="margin-top:8px">
        <table id="logTable"><thead><tr><th>Date</th><th>Bookie</th><th>Event</th><th class="right">Back</th><th class="right">Lay</th><th>Status</th><th class="right">Profit</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div class="charts" style="margin-top:8px">
        <div class="card"><div class="muted">Monthly P&L</div><canvas id="chartMonthly" height="120"></canvas></div>
        <div class="card"><div class="muted">Profit by bookmaker</div><canvas id="chartBookie" height="120"></canvas></div>
      </div>
    </div>
  </section>

  <section id="reports" class="panel">
    <div class="card">
      <div class="charts">
        <div class="card"><div class="muted">Last 30 days P&L</div><canvas id="chart30" height="120"></canvas></div>
        <div class="card"><div class="muted">Streaks</div><div id="streaks" style="margin-top:8px"></div><button id="exportPdf" class="btn sec" style="margin-top:8px"><i class="fa-solid fa-file-pdf"></i> Export PDF</button></div>
      </div>
    </div>
  </section>

  <section id="guide" class="panel"><div class="card"><h3>How to use</h3><ol><li>Calculate and log bets.</li><li>Update statuses in row details.</li><li>Use filters, charts, exports.</li></ol></div></section>
  <section id="bin" class="panel"><div class="card"><h3>Recycle Bin</h3><div class="tableWrap"><table id="binTable"><thead><tr><th>Date</th><th>Bookie</th><th>Event</th><th></th></tr></thead><tbody></tbody></table></div></div></section>

  <div class="footer">v1.1</div>
</div>

<nav class="bottom-nav" aria-label="Primary">
  <button class="navbtn active" data-tab="calc"><i class="fa-solid fa-calculator"></i><span>Calc</span></button>
  <button class="navbtn" data-tab="tracker"><i class="fa-solid fa-table-list"></i><span>Tracker</span></button>
  <button class="navbtn" data-tab="reports"><i class="fa-solid fa-chart-line"></i><span>Reports</span></button>
  <button class="navbtn" data-tab="guide"><i class="fa-solid fa-circle-question"></i><span>Guide</span></button>
  <button class="navbtn" data-tab="bin"><i class="fa-solid fa-trash"></i><span>Bin</span></button>
</nav>

<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
window.addEventListener('load', ()=>{ setTimeout(()=>{ const s=document.getElementById('splash'); if(s){ s.style.opacity='0'; setTimeout(()=>s.remove(), 300);} }, 250); });

const STORE_KEY='mb_store_v3'; const BIN_KEY='mb_recycle_v3';
const $=id=>document.getElementById(id); const fmt=n=>Number(n||0).toFixed(2);
function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id===id));
  document.querySelectorAll('.navbtn').forEach(n=>n.classList.toggle('active', n.dataset.tab===id));
}
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));
document.querySelectorAll('.navbtn').forEach(b=>b.onclick=()=>showTab(b.dataset.tab));

(function seed(){ if(localStorage.getItem('mb_seed_v3')) return;
  function add(o){const c=o.comm/100, lay=(o.type==='QB'&&!o.nsb)?(o.S*(o.B-1))/((o.L-1)*(1-c)):(o.S*o.B)/(o.L*(1-c)), li=lay*(o.L-1); const bw=o.S*(o.B-1)-li, lw=(o.type==='QB'&&!o.nsb)?(lay*(1-c)-o.S):(lay*(1-c)); let a=0; if(o.status==='Back Won') a=+bw.toFixed(2); else if(o.status==='Lay Won') a=+lw.toFixed(2); return {id:crypto.randomUUID(),date:o.date,bookie:o.bookie,event:o.event,type:o.type,backStake:o.S,backOdds:o.B,layStake:lay,layOdds:o.L,liability:li,exp:Math.min(bw,lw),notes:o.notes,noStakeBack:o.nsb,status:o.status,actual:a,backWin:+bw.toFixed(2),layWin:+lw.toFixed(2),comm:o.comm};}
  const d=n=>new Date(Date.now()-n*86400000).toISOString().slice(0,10);
  const data=[
    add({date:d(5), bookie:'SkyBet', event:'Arsenal v Spurs — Draw', type:'QB',  S:20, B:3.2, L:3.35, comm:2, nsb:false, status:'Lay Won'}),
    add({date:d(12),bookie:'Bet365', event:'City v Villa — Over 2.5', type:'SNR', S:10, B:4.5, L:4.6,  comm:2, nsb:true,  status:'Back Won'}),
    add({date:d(18),bookie:'PaddyPower',event:'Chelsea v Brighton — Home', type:'QB', S:25, B:2.1, L:2.14, comm:2, nsb:false, status:'Pending'}),
    add({date:d(25),bookie:'Coral',event:'Liverpool v West Ham — BTTS', type:'QB', S:15, B:3.8, L:3.9, comm:3, nsb:false, status:'Back Won'})
  ];
  localStorage.setItem(STORE_KEY, JSON.stringify(data)); localStorage.setItem('mb_seed_v3','1');
})();

function parseOdds(str, fmt){str=String(str||'').trim(); if(fmt==='dec')return parseFloat(str); if(fmt==='frac'){const m=str.split('/'); if(m.length===2){const a=parseFloat(m[0]),b=parseFloat(m[1]); if(b>0) return 1+a/b;}} if(fmt==='amer'){const a=parseFloat(str); if(isNaN(a))return NaN; return a>=0?1+a/100:1+100/Math.abs(a);} return parseFloat(str);}
function currencySymbol(){return '£';}
function calculate(){const fmtSel=document.getElementById('oddsFormat').value; const t=document.getElementById('betType').value,S=+(document.getElementById('backStake').value||0),B=parseOdds(document.getElementById('backOdds').value,fmtSel),L=parseOdds(document.getElementById('layOdds').value,fmtSel),c=+(document.getElementById('comm').value||0)/100; if(!isFinite(B)||!isFinite(L))return; const nsb=(t==='SNR'); const lay=(t==='QB'&&!nsb)?(S*(B-1))/((L-1)*(1-c)):(S*B)/(L*(1-c)); const layR=Math.max(0, +lay.toFixed(2)); const li=layR*(L-1); const bw=S*(B-1)-li; const lw=(t==='QB'&&!nsb)?(layR*(1-c)-S):(layR*(1-c)); const exp=Math.min(bw,lw); const cur=currencySymbol(); document.getElementById('kLayStake').textContent=cur+fmt(layR); document.getElementById('kLiability').textContent=cur+fmt(li); document.getElementById('kProfit').textContent=cur+fmt(exp); document.getElementById('outBack').textContent=cur+fmt(bw); document.getElementById('outLay').textContent=cur+fmt(lw); return {lay:layR, liability:li, backWin:bw, layWin:lw, exp, nsb, B, L};}
document.getElementById('calcBtn').onclick=calculate;
document.getElementById('logBtn').onclick=()=>{const r=calculate(); if(!r) return; const e={id:crypto.randomUUID(),date:new Date().toISOString().slice(0,10),bookie:document.getElementById('bookie').value||'-',event:document.getElementById('event').value||'-',type:document.getElementById('betType').value,backStake:+document.getElementById('backStake').value,backOdds:r.B,layStake:r.lay,layOdds:r.L,liability:r.liability,exp:r.exp,notes:document.getElementById('notes').value||'',noStakeBack:r.nsb,status:'Pending',actual:0,backWin:+r.backWin.toFixed(2),layWin:+r.layWin.toFixed(2),comm:+document.getElementById('comm').value}; const d=read(); d.push(e); save(d); render(); showTab('tracker');};
function read(){try{return JSON.parse(localStorage.getItem(STORE_KEY)||'[]')}catch{return[]}} function save(d){localStorage.setItem(STORE_KEY, JSON.stringify(d));}
function unique(arr,key){return[...new Set(arr.map(x=>x[key]).filter(Boolean))];} function esc(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;","&gt":"&gt;",""":"&quot;","'":"&#039;"}[m]))}
function buildBookFilter(data){const sel=document.getElementById('bookFilter'); const cur=sel.value; sel.innerHTML='<option value="">All bookmakers</option>'+unique(data,'bookie').map(b=>`<option ${b===cur?'selected':''}>${esc(b)}</option>`).join('');}
function badge(s){const c={'Pending':'status-pending','Back Won':'status-back','Lay Won':'status-lay','Void':'status-void','Cancelled':'status-cancelled'}[s]||'status-pending';return `<span class="status-badge ${c}">${s}</span>`}
function filt(r){const q=(document.getElementById('search').value||'').toLowerCase(),st=document.getElementById('statusFilter').value||'',bk=document.getElementById('bookFilter').value||'',tp=document.getElementById('typeFilter').value||''; if(q && !(`${r.bookie} ${r.event} ${r.notes||''}`.toLowerCase().includes(q))) return false; if(st && r.status!==st) return false; if(bk && r.bookie!==bk) return false; if(tp && r.type!==tp) return false; return true;}
function setKPI(){const rows=read().filter(filt); const actual=rows.reduce((a,x)=>a+Number(x.actual||0),0); const stake=rows.reduce((a,x)=>a+Number(x.backStake||0),0); const roi=stake>0?actual/stake*100:0; const cur=currencySymbol(); document.getElementById('pnlNow').textContent=cur+fmt(actual); document.getElementById('roiNow').textContent=roi.toFixed(1)+'%'; document.getElementById('pendingNow').textContent=String(rows.filter(x=>x.status==='Pending').length);}
function render(){const data=read(); buildBookFilter(data); setKPI(); const rows=data.filter(filt).slice().sort((a,b)=>b.date.localeCompare(a.date)); const tb=document.querySelector('#logTable tbody'); tb.innerHTML=''; const cur=currencySymbol(); rows.forEach(r=>{const tr=document.createElement('tr'); tr.dataset.id=r.id; tr.innerHTML=`<td>${r.date}</td><td>${esc(r.bookie)}</td><td>${esc(r.event)}</td><td class=right>${cur}${fmt(r.backStake)}</td><td class=right>${cur}${fmt(r.layStake)}</td><td>${badge(r.status)}</td><td class=right>${cur}${fmt(r.actual||0)}</td><td class=right><button class="btn sec" data-expand="${r.id}"><i class="fa-solid fa-caret-down"></i></button><button class="btn sec" data-del="${r.id}"><i class="fa-solid fa-trash"></i></button></td>`; tb.appendChild(tr); const det=document.createElement('tr'); det.className='details'; det.dataset.for=r.id; const odds=`Back @ ${Number(r.backOdds).toFixed(2)} | Lay @ ${Number(r.layOdds).toFixed(2)} | Comm ${Number(r.comm||0).toFixed(2)}%`; det.innerHTML=`<td colspan=8><details class=rowx><summary class=muted>Details</summary><div class=row style="margin-top:8px"><div><div class=muted>Type</div><div>${r.type}${r.noStakeBack?' (NSB)':''}</div></div><div><div class=muted>Liability</div><div>${cur}${fmt(r.liability)}</div></div><div><div class=muted>Odds / Comm</div><div>${esc(odds)}</div></div><div><div class=muted>Expected Profit</div><div>${cur}${fmt(r.exp)}</div></div></div>${r.notes?`<div style="margin-top:8px"><div class=muted>Notes</div><div>${esc(r.notes)}</div></div>`:''}<div style="margin-top:8px"><label class=muted>Update status</label><select class=statusSel><option ${r.status==='Pending'?'selected':''}>Pending</option><option ${r.status==='Back Won'?'selected':''}>Back Won</option><option ${r.status==='Lay Won'?'selected':''}>Lay Won</option><option ${r.status==='Void'?'selected':''}>Void</option><option ${r.status==='Cancelled'?'selected':''}>Cancelled</option></select></div></details></td>`; tb.appendChild(det);}); drawCharts();}
['search','statusFilter','bookFilter','typeFilter'].forEach(id=>document.getElementById(id).addEventListener('input',render)); document.getElementById('clearFilters').onclick=()=>{document.getElementById('search').value='';document.getElementById('statusFilter').value='';document.getElementById('bookFilter').value='';document.getElementById('typeFilter').value='';render()};
document.addEventListener('click',e=>{const ex=e.target.closest('[data-expand]'); if(ex){const id=ex.dataset.expand;const row=document.querySelector(`tr[data-id="${id}"]`);const nxt=row&&row.nextSibling;if(nxt&&nxt.classList&&nxt.classList.contains('details')){nxt.querySelector('details').open=!nxt.querySelector('details').open;}} const del=e.target.closest('[data-del]'); if(del){if(confirm('Delete this entry?')){const id=del.dataset.del;const d=read(); const idx=d.findIndex(x=>x.id===id); if(idx>=0){ const [removed]=d.splice(idx,1); const b=readBin(); b.push(removed); saveBin(b); save(d); render(); } } }});
document.addEventListener('change',e=>{if(e.target.classList.contains('statusSel')){const drow=e.target.closest('tr'); const prow=drow.previousSibling; const id=prow?.dataset?.id; if(!id) return; const d=read(); const r=d.find(x=>x.id===id); r.status=e.target.value; const c=Number(r.comm||0)/100, S=Number(r.backStake), B=Number(r.backOdds), L=Number(r.layOdds); const liability = r.liability ?? r.layStake*(L-1); const backWin = S*(B-1) - liability; const layWin = (r.type==='QB' && !r.noStakeBack) ? (r.layStake*(1-c) - S) : (r.layStake*(1-c)); r.backWin=Number(backWin.toFixed(2)); r.layWin=Number(layWin.toFixed(2)); if(r.status==='Back Won') r.actual=r.backWin; else if(r.status==='Lay Won') r.actual=r.layWin; else r.actual=0; save(d); render();}});
let chartMonthly, chartBookie, chart30;
function drawCharts(){const rows=read().slice().sort((a,b)=>a.date.localeCompare(b.date)); const monthMap=new Map(); rows.forEach(r=>{ const k=(r.date||'').slice(0,7)||'-'; monthMap.set(k,(monthMap.get(k)||0)+Number(r.actual||0)); }); const mLabels=[...monthMap.keys()], mVals=mLabels.map(k=>Number((monthMap.get(k)||0).toFixed(2))); if(chartMonthly) chartMonthly.destroy(); chartMonthly=new Chart(document.getElementById('chartMonthly'),{type:'line',data:{labels:mLabels,datasets:[{data:mVals,tension:.25}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}}); const bMap=new Map(); rows.forEach(r=>{ bMap.set(r.bookie,(bMap.get(r.bookie)||0)+Number(r.actual||0)); }); const bLabels=[...bMap.keys()].slice(0,10), bVals=bLabels.map(k=>Number((bMap.get(k)||0).toFixed(2))); if(chartBookie) chartBookie.destroy(); chartBookie=new Chart(document.getElementById('chartBookie'),{type:'pie',data:{labels:bLabels,datasets:[{data:bVals}]},options:{plugins:{legend:{position:'bottom'}}}}); const today=new Date(); const rows30=rows.filter(r=>((today - new Date(r.date))/86400000)<=30); const dayMap=new Map(); for(let i=29;i>=0;i--){ const d=new Date(today- i*86400000).toISOString().slice(0,10); dayMap.set(d,0); } rows30.forEach(r=>{ const k=r.date; dayMap.set(k,(dayMap.get(k)||0)+Number(r.actual||0)); }); const dLabels=[...dayMap.keys()], dVals=dLabels.map(k=>Number((dayMap.get(k)||0).toFixed(2))); if(chart30) chart30.destroy(); chart30=new Chart(document.getElementById('chart30'),{type:'bar',data:{labels:dLabels,datasets:[{data:dVals}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{beginAtZero:true}}}}); let winStreak=0, bestWin=0, loseStreak=0, worstLose=0; rows.forEach(r=>{ if((r.actual||0)>0){ winStreak++; loseStreak=0; if(winStreak>bestWin) bestWin=winStreak; } else if((r.actual||0)<0){ loseStreak++; winStreak=0; if(loseStreak>worstLose) worstLose=loseStreak; } else { winStreak=0; loseStreak=0; } }); document.getElementById('streaks').textContent=`Best winning streak: ${bestWin}   |   Worst losing streak: ${worstLose}`;}
function rowsToCSV(rows){const headers=['id','date','bookie','event','type','backStake','backOdds','layStake','layOdds','liability','exp','actual','status','notes','noStakeBack','comm','backWin','layWin']; return [headers.join(','), ...rows.map(x=>headers.map(h=>JSON.stringify(x[h]??'')).join(','))].join('\n');}
function downloadBlob(content, name, type){const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);}
document.getElementById('exportPdf')?.addEventListener('click',()=>{const { jsPDF } = window.jspdf; const doc=new jsPDF(); const rows=read(); const total=rows.reduce((a,x)=>a+Number(x.actual||0),0); doc.text('Matched Betting Summary',14,16); doc.text('Total P&L: £'+fmt(total),14,26); doc.save('mb_summary.pdf');});
document.getElementById('exportCsv').onclick=()=>{const d=read(); if(!d.length) return; downloadBlob(rowsToCSV(d),'matched_bets.csv','text/csv');};
document.getElementById('exportXlsx').onclick=()=>{const d=read(); if(!d.length) return; const ws=XLSX.utils.json_to_sheet(d); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Bets'); XLSX.writeFile(wb,'matched_bets.xlsx');};
document.getElementById('importCsv').onclick=()=>document.getElementById('csvInput').click();
document.getElementById('csvInput').onchange=e=>{const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{const text=rd.result; const lines=text.split(/\r?\n/).filter(Boolean); const headers=lines.shift().split(',').map(h=>h.replace(/^"|"$/g,'')); const idx=h=>headers.indexOf(h); const data=read(); const seen=new Set(data.map(x=>x.id)); lines.forEach(line=>{const cols=line.match(/("([^"]|"")*"|[^,]+)/g)||[]; const getv=h=>{const i=idx(h); if(i<0) return ''; return (cols[i]||'').replace(/^"|"$/g,'').replace(/""/g,'"')}; const id=getv('id')||crypto.randomUUID(); const entry={id, date:getv('date')||new Date().toISOString().slice(0,10), bookie:getv('bookie')||'-', event:getv('event')||'-', type:getv('type')||'QB', backStake:Number(getv('backStake')||0), backOdds:Number(getv('backOdds')||0), layStake:Number(getv('layStake')||0), layOdds:Number(getv('layOdds')||0), liability:Number(getv('liability')||0), exp:Number(getv('exp')||0), actual:Number(getv('actual')||0), status:getv('status')||'Pending', notes:getv('notes')||'', noStakeBack:(getv('noStakeBack')||'').toLowerCase()==='true', comm:Number(getv('comm')||0), backWin:Number(getv('backWin')||NaN), layWin:Number(getv('layWin')||NaN)}; if(seen.has(id)){ Object.assign(data.find(x=>x.id===id), entry); } else { data.push(entry); seen.add(id); }}); save(data); render(); e.target.value='';}; rd.readAsText(f);};
function readBin(){ try{return JSON.parse(localStorage.getItem(BIN_KEY)||'[]')}catch{return[]} } function saveBin(b){ localStorage.setItem(BIN_KEY, JSON.stringify(b)); }
function renderBin(){ const b=readBin(), tb=document.querySelector('#binTable tbody'); tb.innerHTML=''; b.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date||''}</td><td>${esc(r.bookie||'')}</td><td>${esc(r.event||'')}</td><td><button class="btn sec" data-restore="${r.id}">Restore</button></td>`; tb.appendChild(tr); }); }
document.addEventListener('click',e=>{ const rs=e.target.closest('[data-restore]'); if(rs){ const id=rs.dataset.restore; const b=readBin(); const idx=b.findIndex(x=>x.id===id); if(idx>=0){ const d=read(); d.push(b[idx]); b.splice(idx,1); saveBin(b); save(d); render(); renderBin(); } } });
render(); drawCharts(); renderBin();
</script>
</body>
</html>
